extends layout

block content

  div.container
    div.row
      div.inline
        p.section-title Upload your patient medical records here

        //- p.marginTop Upload to File Server
        form#formUpload(method='POST' action='/upload/fileUploadToServer' enctype="multipart/form-data")
          div.input-group
            div.custom-file
              label.custom-file-label(for='file-upload') File Upload
              input#file-upload.custom-file-input(type="file" name='upload')
            div.input-group-append
              //- button.btn.btn-primary(type='submit') Upload
              button.btn.btn-primary(onclick="uploadFile()") Upload

        //- div.container.marginTop OR
        //- p.marginTop Upload to File Storage
        //- div.input-group.marginTop
        //-   div.custom-file
        //-       label.custom-file-label(for='s3Upload') File Upload
        //-       input#s3Upload.custom-file-input(type="file" name='upload')
        //-   div.input-group-append
        //-       button.btn.btn-primary(onclick="uploadFile()") Upload to S3

    div.container
      button.btn.btn-primary.siteGradient.marginTop10.callToActionButton(onclick="window.location.href='/'") Log Out

      //- div.col-lg-6.col-md-6.col-sm-6.col-xs-6.inline
      //-   p.section-title Amazon S3 Bucket
      //-   form(method='PUT' action='/upload/fileUploadToS3' enctype="multipart/form-data")

    //-   div.container
    //-     form(method='GET' action='/upload/eicar.com' enctype="multipart/form-data")
    //-         div.input-group-append
    //-             button.btn.btn-primary(typ="submit") Get Eicar

  script.
    $('#file-upload').on('change',function(){        
        var fileName = document.getElementById("file-upload");
        //- console.log(fileName);
        if (fileName) {
          //- console.log(fileName.files[0].name);          
          document.getElementsByClassName('custom-file-label')[0].innerHTML = "Uploading " + fileName.files[0].name + "...";          
        }
    })
  
  script(src='https://sdk.amazonaws.com/js/aws-sdk-2.693.0.js')

  script.
      var bucketName = "filestoragesecurity-scanning-bucket-0mv3pa";
      var bucketRegion = "us-east-1";
      var IdentityPoolId = "us-east-1:e5756dab-32cd-497f-bdf9-dfeddd1aa32d";

      AWS.config.region = bucketRegion
      AWS.config.credentials = new AWS.CognitoIdentityCredentials({
          IdentityPoolId: IdentityPoolId
      })

      var s3 = new AWS.S3({
          apiVersion: "2006-03-01",
          params: { Bucket: bucketName }
      });

      function uploadFile() {       

        //- var params = {
        //-   Bucket: "examplebucket"
        //- };
        //- s3.createBucket(params, function(err, data) {
        //-   if (err) console.log(err, err.stack); // an error occurred
        //-   else     console.log(data);           // successful response
        //-   /*
        //-   data = {
        //-     Location: "/examplebucket"
        //-   }
        //-   */
        //- });
        
        let folderName = "uploads";
        //- console.log(folderName);
        console.log(document.getElementById("file-upload"));
        var files = document.getElementById("file-upload").files;
        if (!files.length) {
            return alert("Please choose a file to upload first.");
        }
        var file = files[0];
        var fileName = file.name;
        var folderFilesKey = encodeURIComponent(folderName) + "/";

        var fileKey = folderFilesKey + fileName;

        // Use S3 ManagedUpload class as it supports multipart uploads
        var upload = new AWS.S3.ManagedUpload({
            params: {
                Bucket: bucketName,
                Key: fileKey,
                Body: file
            }
        });

        var promise = upload.promise();

        promise.then(
            function (data) {
                alert("Successfully uploaded file.");                
                document.getElementById("formUpload").submit();
            },
            function (err) {
                return alert("There was an error uploading your file: ", err.message);
            }
        );
      }
